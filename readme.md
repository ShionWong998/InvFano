 # Inversly designing tunable Fano resonators with 2D materials using S4, LNN and DE

Please refer my [paper](https://iopscience.iop.org/article/10.1088/1402-4896/adfbc7) if you are interested in this project. Thank you.
https://iopscience.iop.org/article/10.1088/1402-4896/adfbc7

Author: Xiatong Wang(me), Kaida Xu, Yuanmei Xu, Qijia Weng, Junyan Cheng and Xueshi Li.

Guangdong University of Technology

This is the implement of article *"Inverse design of tunable high-sensitivity Fano resonators with black phosphorus utilizing deep learning"*. In this work we take black phosphorus as an example to design tunable Fano resonators. 


## Geting Started
### Installation

Before you started S4 should be installed first. Please follow appendix section to install S4 because this part will take you a lot more time and occupy a lot of space here. 

**Conda enviroment setting up**

```shell
# create new environment
# if you followed appendix section first, you won't need this
$ conda create -n Fano python=3.9
$ conda activate Fano
$ pip install numpy

# but those still need though
$ pip install matplotlib
$ pip install pandas
$ pip install torch torchvision
```

**Clone from github**
```shell
$ git clone 
$ cd 
```
## Run the Model
### Generate Permitivitties of 2D Materials
```shell
$ cd BPeps
$ python BPeps.py
$ cd ..
```
### Generate Datasets
Dataset is generated by S4. Run:
```shell
$ python generate_shape.py
$ python Get_Trans.py
```
This may cause tons of time to generate 50,625 spectra. You can refer instructions in [here](#jump1).

After that,
```shell
$ python stack.py
$ python wash.py
```
You will get `wash_all.csv`.

<span id="jump2"></span>If you need some random generated test datasets,
```shell
$ cd testset
$ python generate_shape.py
$ python Get_Trans.py
# wait till end
$ python stack.py
$ python wash.py
$ cd ..
```
You will get `wash_test.csv`.

### Start Training
```shell
$ python fowardnet.py
```
You will get `fn.pt` , which is the checkpoint of network training result.

If you gonna test the network with test dataset,
```shell
$ python fntest.py
$ python plot.py
```
These will generate figures in `./plots/` folder that plot test dataset and test results.

### Inverse Design
This section uses `./testset/rest.csv` as design targets, so if you haven't generated [test dataset](#jump2), do it now.
```shell
$ python de.py
```
You will get `outout.csv` , which is the final design result.
## Real Talks
1. <span id="jump1"></span> You can boost the dataset generation by activating multiple threads. Split `shape.csv` manually or by programs and use commands like
```shell
$ taskset -c 0-1 python Get_Trans.py
```
2. Because of unknown reasons you cannot just activate multiple programs or all cpu threads would be occupied by single program and can not keep simulating.
3. The whole generating progress will take about 10*24 hrs (on my PC with CPU i5-13600k). So I highly recommed you follow 2 to run multiple threads.
4. You can install either cpu or gpu version Pytorch, in this document cpu version is installed.
5. Some codes in `de.py` are refered from [S. S. Panda's](https://opg.optica.org/ol/fulltext.cfm?uri=ol-47-10-2586&id=472839) source code.
6. I'm sorry about my poor coding skills. I will be appreciated if you have suggestions.
7. If you want to contact me, please email shionjk@126.com. If you are interested in the theory or methodology about this project you can also email my mentor with lixueshi@gdut.edu.cn.

## Appendix
### S4 installation
*This section is refered from [S4 Utils's wiki](https://s4utils.readthedocs.io/en/latest/DownloadInstall.html) and [RayFlare's wiki](https://rayflare.readthedocs.io/en/latest/Installation/installation.html#setting-up-to-install-s4-on-ubuntu).*

*You can find tutorials about S4 in [S4 official website](https://web.stanford.edu/group/fan/S4/index.html).*

**S4 is only recommend working on ubuntu** because of intel mkl's compability.

**Intel MKL installation**
```shell
$ sudo bash
# type your password when prompted
$ cd /tmp
$ wget https://apt.repos.intel.com/intel-gpg-keys/GPG-PUB-KEY-INTEL-SW-PRODUCTS-2019.PUB
$ apt-key add GPG-PUB-KEY-INTEL-SW-PRODUCTS-2019.PUB
$ rm GPG-PUB-KEY-INTEL-SW-PRODUCTS-2019.PUB
$ exit
$ sudo sh -c 'echo deb https://apt.repos.intel.com/mkl all main > /etc/apt/sources.list.d/intel-mkl.list'
$ sudo apt update
$ sudo apt install intel-mkl-2020.0-088
```
**Compliers installation**
```shell
$ sudo apt install make git gcc g++ gfortran libopm-dev
$ sudo apt-get install libopenblas-dev libfftw3-dev libsuitesparse-dev libbost-all-dev
$ conda create -n Fano python=3.9
$ pip install wheel setuptools numba
$ git clone https://github.com/phoebe-p/S4.git
$ cd S4
```
Before you run makefile you can check the following lines:
```shell
BLAS_LIB = -lbas
LAPACK_LIB = -llapack
FFTW3_INC = 
FFTW3_LIB = -lfftw3
```
Then compile:
```shell
$ make boost
# This command may not necessary, but whatever.
$ make S4_pyext
```
When make is complete, run:
```shell
$ pip install ./
```